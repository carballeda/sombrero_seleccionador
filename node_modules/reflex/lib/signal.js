"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var absent = new String("absent");

var Input = function () {
  _createClass(Input, null, [{
    key: "Address",
    value: function Address(signal) {
      if (signal.address == null) {
        signal.address = signal.receive.bind(signal);

        return signal.address;
      } else {
        return signal.address;
      }
    }
  }, {
    key: "notify",
    value: function notify(message, addressBook, from, to) {
      var exception = absent;
      try {
        while (from < to) {
          var address = addressBook[from];
          if (address != null) {
            address(message);
          }
          from = from + 1;
        }
      } catch (error) {
        exception = error;
      }

      if (from < to) {
        Input.notify(message, addressBook, from + 1, to);
      }

      if (exception != absent) {
        throw exception;
      }
    }
  }, {
    key: "connect",
    value: function connect(signal, address) {
      if (signal.addressBook == null) {
        signal.addressBook = [address];
      } else {
        var addressBook = signal.addressBook;
        if (addressBook.indexOf(address) < 0) {
          addressBook.push(address);
        }
      }
    }
  }]);

  function Input(value) {
    _classCallCheck(this, Input);

    this.value = value;
    this.isBlocked = false;

    this.addressBook = null;
    this.queue = null;
    this.address = null;
  }

  _createClass(Input, [{
    key: "receive",
    value: function receive(value) {
      if (this.isBlocked) {
        if (this.queue == null) {
          this.queue = [value];
        } else {
          this.queue.push(value);
        }
      } else {
        var exception = absent;
        this.isBlocked = true;
        try {
          this.value = value;

          if (this.addressBook != null) {
            var addressBook = this.addressBook;
            Input.notify(value, addressBook, 0, addressBook.length);
          }
        } catch (error) {
          exception = error;
        }

        this.isBlocked = false;
        if (this.queue != null && this.queue.length > 0) {
          this.receive(value = this.queue.shift());
        }

        if (exception != absent) {
          throw exception;
        }
      }
    }
  }, {
    key: "subscribe",
    value: function subscribe(address) {
      Input.connect(this, address);
      address(this.value);
    }
  }, {
    key: "connect",
    value: function connect(address) {
      if (this.addressBook == null) {
        this.addressBook = [address];
      } else {
        var addressBook = this.addressBook;
        if (addressBook.indexOf(address) < 0) {
          addressBook.push(address);
        }
      }
    }
  }]);

  return Input;
}();

Input.prototype.$type = "Signal.Signal";

var Inbox = function Inbox(message) {
  _classCallCheck(this, Inbox);

  this.signal = new Input(message);
  this.address = Input.Address(this.signal);
};

Inbox.prototype.$type = "Signal.Mailbox";

var mailbox = exports.mailbox = function mailbox(message) {
  return new Inbox(message);
};

var Forward = function Forward(address, tag) {
  var forward = function forward(message) {
    return address(tag(message));
  };
  forward.to = address;
  forward.tag = tag;
  return forward;
};

if (global['reflex/address'] == null) {
  global['reflex/address'] = 0;
}

var forward = exports.forward = function forward(address, tag) {
  var id = address.id != null ? address.id : address.id = global['reflex/address']++;
  var key = "reflex/address/" + id;

  return tag[key] || (tag[key] = Forward(address, tag));
};

var reductions = exports.reductions = function reductions(step, state, input) {
  var output = new Input(state);
  input.connect(forward(Input.Address(output), function (value) {
    return step(output.value, value);
  }));
  return output;
};

var map = exports.map = function map(f, input) {
  var output = new Input(f(input.value));
  input.connect(forward(Input.Address(output), f));
  return output;
};
//# sourceMappingURL=data:application/json;base64,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O0NBRm5CIiwiZmlsZSI6InNpZ25hbC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qIEBmbG93ICovXG5cblxuLyo6OlxuaW1wb3J0IHR5cGUge0FkZHJlc3MsIFNpZ25hbCwgTWFpbGJveH0gZnJvbSBcIi4vc2lnbmFsXCJcbmltcG9ydCB0eXBlIHtUcmFuc2xhdGUsIFJlZHVjZXIsIEFkZHJlc3NCb29rfSBmcm9tIFwiLi9zaWduYWxcIlxuXG5leHBvcnQgdHlwZSB7U2lnbmFsLCBBZGRyZXNzLCBNYWlsYm94fVxuZXhwb3J0IHR5cGUge1RyYW5zbGF0ZSwgUmVkdWNlciwgQWRkcmVzc0Jvb2t9XG4qL1xuXG5jb25zdCBhYnNlbnQgPSBuZXcgU3RyaW5nKFwiYWJzZW50XCIpXG5cbmNsYXNzIElucHV0IC8qOjo8YT4qLyB7XG4gIC8qOjpcbiAgJHR5cGU6IFwiU2lnbmFsLlNpZ25hbFwiO1xuICB2YWx1ZTogYTtcbiAgYWRkcmVzc0Jvb2s6ID9BZGRyZXNzQm9vazxhPjtcbiAgaXNCbG9ja2VkOiBib29sZWFuO1xuICBxdWV1ZTogP0FycmF5PGE+O1xuICBhZGRyZXNzOiA/QWRkcmVzczxhPjtcbiAgKi9cbiAgc3RhdGljIEFkZHJlc3MgLyo6OjxtZXNzYWdlPiovKHNpZ25hbC8qOklucHV0PG1lc3NhZ2U+Ki8pLyo6QWRkcmVzczxtZXNzYWdlPiove1xuICAgIGlmIChzaWduYWwuYWRkcmVzcyA9PSBudWxsKSB7XG4gICAgICBzaWduYWwuYWRkcmVzcyA9IHNpZ25hbC5yZWNlaXZlLmJpbmQoc2lnbmFsKVxuICAgICAgLy8gVE9ETzogU3VibWl0IGEgYnVnIGZvciBmbG93IGFzIHJldHVybiBoZXJlIGFuZCBlbHNlIGNsYXVzZSBpc1xuICAgICAgLy8gcmVkdW5kdW50LlxuICAgICAgcmV0dXJuIHNpZ25hbC5hZGRyZXNzXG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBzaWduYWwuYWRkcmVzc1xuICAgIH1cbiAgfVxuICBzdGF0aWMgbm90aWZ5KG1lc3NhZ2UvKjphKi8sIGFkZHJlc3NCb29rLyo6QWRkcmVzc0Jvb2s8YT4qLywgZnJvbS8qOm51bWJlciovLCB0by8qOm51bWJlciovKS8qOnZvaWQqLyB7XG4gICAgbGV0IGV4Y2VwdGlvbiA9IGFic2VudFxuICAgIHRyeSB7XG4gICAgICB3aGlsZSAoZnJvbSA8IHRvKSB7XG4gICAgICAgIGNvbnN0IGFkZHJlc3MgPSBhZGRyZXNzQm9va1tmcm9tXVxuICAgICAgICBpZiAoYWRkcmVzcyAhPSBudWxsKSB7XG4gICAgICAgICAgYWRkcmVzcyhtZXNzYWdlKVxuICAgICAgICB9XG4gICAgICAgIGZyb20gPSBmcm9tICsgMVxuICAgICAgfVxuICAgIH1cbiAgICBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGV4Y2VwdGlvbiA9IGVycm9yXG4gICAgfVxuXG4gICAgaWYgKGZyb20gPCB0bykge1xuICAgICAgSW5wdXQubm90aWZ5KG1lc3NhZ2UsIGFkZHJlc3NCb29rLCBmcm9tICsgMSwgdG8pXG4gICAgfVxuXG4gICAgaWYgKGV4Y2VwdGlvbiAhPSBhYnNlbnQpIHtcbiAgICAgIHRocm93IGV4Y2VwdGlvblxuICAgIH1cbiAgfVxuICBzdGF0aWMgY29ubmVjdChzaWduYWwvKjpJbnB1dDxhPiovLCBhZGRyZXNzLyo6QWRkcmVzczxhPiovKSB7XG4gICAgaWYgKHNpZ25hbC5hZGRyZXNzQm9vayA9PSBudWxsKSB7XG4gICAgICBzaWduYWwuYWRkcmVzc0Jvb2sgPSBbYWRkcmVzc11cbiAgICB9IGVsc2Uge1xuICAgICAgLy8gVE9ETzogU3VibWl0IGEgZmxvdyBidWcgdGhhdCBzZWVtcyB0byBvY2N1ciBpZiBvYnNlcnZlcnMgYXJlbid0IGNvcHlpZWRcbiAgICAgIC8vIHByZXN1bWFibHkgYmVjYXVzZSBpdCBhc3N1bWVzIHRoYXQgYHRoaXMub2JzZXJ2ZXIuaW5kZXhPZihvYnNlcnZlcilgXG4gICAgICAvLyBtYXkgbXV0YXRlIHRoaXMuXG4gICAgICBjb25zdCBhZGRyZXNzQm9vayA9IHNpZ25hbC5hZGRyZXNzQm9va1xuICAgICAgaWYgKGFkZHJlc3NCb29rLmluZGV4T2YoYWRkcmVzcykgPCAwKSB7XG4gICAgICAgIGFkZHJlc3NCb29rLnB1c2goYWRkcmVzcylcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgY29uc3RydWN0b3IodmFsdWUvKjphKi8pIHtcbiAgICB0aGlzLnZhbHVlID0gdmFsdWVcbiAgICB0aGlzLmlzQmxvY2tlZCA9IGZhbHNlXG5cbiAgICB0aGlzLmFkZHJlc3NCb29rID0gbnVsbFxuICAgIHRoaXMucXVldWUgPSBudWxsXG4gICAgdGhpcy5hZGRyZXNzID0gbnVsbFxuICB9XG4gIHJlY2VpdmUodmFsdWUvKjphKi8pIHtcbiAgICAvLyBJZiBzaWduYWwgaXMgYmxvY2tlZCBxdWV1ZSB0cmFuc2FjdGlvbiB0byBiZSBwcm9jZXNzZWQgb25jZSBpdCBpc1xuICAgIC8vIHVuYmxvY2tlZC5cbiAgICBpZiAodGhpcy5pc0Jsb2NrZWQpIHtcbiAgICAgIGlmICh0aGlzLnF1ZXVlID09IG51bGwpIHtcbiAgICAgICAgdGhpcy5xdWV1ZSA9IFt2YWx1ZV1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMucXVldWUucHVzaCh2YWx1ZSlcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgbGV0IGV4Y2VwdGlvbiA9IGFic2VudFxuICAgICAgdGhpcy5pc0Jsb2NrZWQgPSB0cnVlXG4gICAgICB0cnkge1xuICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWVcblxuICAgICAgICBpZiAodGhpcy5hZGRyZXNzQm9vayAhPSBudWxsKSB7XG4gICAgICAgICAgY29uc3QgYWRkcmVzc0Jvb2sgPSB0aGlzLmFkZHJlc3NCb29rXG4gICAgICAgICAgSW5wdXQubm90aWZ5KHZhbHVlLCBhZGRyZXNzQm9vaywgMCwgYWRkcmVzc0Jvb2subGVuZ3RoKVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgZXhjZXB0aW9uID0gZXJyb3JcbiAgICAgIH1cblxuICAgICAgdGhpcy5pc0Jsb2NrZWQgPSBmYWxzZVxuICAgICAgaWYgKHRoaXMucXVldWUgIT0gbnVsbCAmJiB0aGlzLnF1ZXVlLmxlbmd0aCA+IDApIHtcbiAgICAgICAgdGhpcy5yZWNlaXZlKHZhbHVlID0gdGhpcy5xdWV1ZS5zaGlmdCgpKVxuICAgICAgfVxuXG4gICAgICBpZiAoZXhjZXB0aW9uICE9IGFic2VudCkge1xuICAgICAgICB0aHJvdyBleGNlcHRpb25cbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgc3Vic2NyaWJlKGFkZHJlc3MvKjpBZGRyZXNzPGE+Ki8pLyo6dm9pZCovIHtcbiAgICBJbnB1dC5jb25uZWN0KHRoaXMsIGFkZHJlc3MpXG4gICAgYWRkcmVzcyh0aGlzLnZhbHVlKVxuICB9XG4gIGNvbm5lY3QoYWRkcmVzcy8qOkFkZHJlc3M8YT4qLykge1xuICAgIGlmICh0aGlzLmFkZHJlc3NCb29rID09IG51bGwpIHtcbiAgICAgIHRoaXMuYWRkcmVzc0Jvb2sgPSBbYWRkcmVzc11cbiAgICB9IGVsc2Uge1xuICAgICAgLy8gVE9ETzogU3VibWl0IGEgZmxvdyBidWcgdGhhdCBzZWVtcyB0byBvY2N1ciBpZiBvYnNlcnZlcnMgYXJlbid0IGNvcHlpZWRcbiAgICAgIC8vIHByZXN1bWFibHkgYmVjYXVzZSBpdCBhc3N1bWVzIHRoYXQgYHRoaXMub2JzZXJ2ZXIuaW5kZXhPZihvYnNlcnZlcilgXG4gICAgICAvLyBtYXkgbXV0YXRlIHRoaXMuXG4gICAgICBjb25zdCBhZGRyZXNzQm9vayA9IHRoaXMuYWRkcmVzc0Jvb2tcbiAgICAgIGlmIChhZGRyZXNzQm9vay5pbmRleE9mKGFkZHJlc3MpIDwgMCkge1xuICAgICAgICBhZGRyZXNzQm9vay5wdXNoKGFkZHJlc3MpXG4gICAgICB9XG4gICAgfVxuICB9XG59XG5JbnB1dC5wcm90b3R5cGUuJHR5cGUgPSBcIlNpZ25hbC5TaWduYWxcIlxuXG5jbGFzcyBJbmJveCAvKjo6PG1lc3NhZ2U+Ki8ge1xuICAvKjo6XG4gICR0eXBlOiBcIlNpZ25hbC5NYWlsYm94XCI7XG4gIHNpZ25hbDogU2lnbmFsPG1lc3NhZ2U+O1xuICBhZGRyZXNzOiBBZGRyZXNzPG1lc3NhZ2U+O1xuICAqL1xuICBjb25zdHJ1Y3RvcihtZXNzYWdlLyo6bWVzc2FnZSovKSB7XG4gICAgdGhpcy5zaWduYWwgPSBuZXcgSW5wdXQobWVzc2FnZSlcbiAgICB0aGlzLmFkZHJlc3MgPSBJbnB1dC5BZGRyZXNzKHRoaXMuc2lnbmFsKVxuICB9XG59XG5JbmJveC5wcm90b3R5cGUuJHR5cGUgPSBcIlNpZ25hbC5NYWlsYm94XCJcblxuZXhwb3J0IGNvbnN0IG1haWxib3ggPSAvKjo6PG1lc3NhZ2U+Ki9cbiAgKG1lc3NhZ2UvKjptZXNzYWdlKi8pLyo6TWFpbGJveDxtZXNzYWdlPiovID0+XG4gIG5ldyBJbmJveChtZXNzYWdlKVxuXG5cbmNvbnN0IEZvcndhcmQgPSAvKjo6PGEsYj4qL1xuICAoIGFkZHJlc3MvKjpBZGRyZXNzPGI+Ki9cbiAgLCB0YWcvKjooYTphKT0+YiovXG4gICkvKjpBZGRyZXNzPGE+Ki8gPT4ge1xuICAgIGNvbnN0IGZvcndhcmQgPSAobWVzc2FnZS8qOmEqLykgPT4gYWRkcmVzcyh0YWcobWVzc2FnZSkpXG4gICAgZm9yd2FyZC50byA9IGFkZHJlc3NcbiAgICBmb3J3YXJkLnRhZyA9IHRhZ1xuICAgIHJldHVybiBmb3J3YXJkXG4gIH1cblxuaWYgKGdsb2JhbFsncmVmbGV4L2FkZHJlc3MnXSA9PSBudWxsKSB7XG4gIGdsb2JhbFsncmVmbGV4L2FkZHJlc3MnXSA9IDBcbn1cblxuLy8gQ3JlYXRlIGEgbmV3IGFkZHJlc3MuIFRoaXMgYWRkcmVzcyB3aWxsIHRhZyBlYWNoIG1lc3NhZ2UgaXQgcmVjZWl2ZXMgYW5kIHRoZW5cbi8vIGZvcndhcmQgaXQgYWxvbmcgdG8gdGhlIGdpdmVuIGFkZHJlc3MuXG4vLyBFeGFtcGxlOlxuLy9cbi8vIGNvbnN0IFJlbW92ZSA9IHRhcmdldCA9PiB7dHlwZTogXCJSZW1vdmVcIiwgdGFyZ2V0fVxuLy8gcmVtb3ZlQWRkcmVzcyA9IGZvcndhcmQoYWRkcmVzcywgUmVtb3ZlKVxuLy9cbi8vIEFib3ZlIGV4YW1wbGUgY3JlYXRlZCBgcmVtb3ZlQWRkcmVzc2AgdGFncyBlYWNoIG1lc3NhZ2Ugd2l0aCBgUmVtb3ZlYCB0YWdcbi8vIGJlZm9yZSBmb3J3YXJkaW5nIHRoZW0gdG8gYSBnZW5lcmFsIGBhZGRyZXNzYC5cbmV4cG9ydCBjb25zdCBmb3J3YXJkID0gLyo6OjxhLCBiPiovXG4gICggYWRkcmVzcy8qOkFkZHJlc3M8YT4qL1xuICAsIHRhZy8qOlRyYW5zbGF0ZTxiLCBhPiovXG4gICkvKjpBZGRyZXNzPGI+Ki8gPT4ge1xuICAgIC8vIEdlbnJhdGUgSUQgZm9yIGVhY2ggYWRkcmVzcyB0aGF0IGhhcyBhIGZvcndhcmRpbmcgYWRkcmVzc2VzIHNvIHRoYXRcbiAgICAvLyBmb3J3YXJkaW5nIGFkZHJlc3NlcyBjb3VsZCBiZSBjYWNoZWQgYnkgdGhhdCBpZCBhbmQgYSB0YWctaW5nIGZ1bmN0aW9uLlxuICAgIGNvbnN0IGlkID0gYWRkcmVzcy5pZCAhPSBudWxsID8gYWRkcmVzcy5pZCA6XG4gICAgICAgICAgICAgICAoYWRkcmVzcy5pZCA9IGdsb2JhbFsncmVmbGV4L2FkZHJlc3MnXSsrKTtcbiAgICBjb25zdCBrZXkgPSBgcmVmbGV4L2FkZHJlc3MvJHtpZH1gXG5cbiAgICByZXR1cm4gdGFnW2tleV0gfHwgKHRhZ1trZXldID0gRm9yd2FyZChhZGRyZXNzLCB0YWcpKVxuICB9XG5cblxuZXhwb3J0IGNvbnN0IHJlZHVjdGlvbnMgPSAvKjo6PHN0YXRlLCBpbnB1dD4qL1xuICAoIHN0ZXAvKjpSZWR1Y2VyPHN0YXRlLCBpbnB1dD4qL1xuICAsIHN0YXRlLyo6c3RhdGUqL1xuICAsIGlucHV0Lyo6U2lnbmFsPGlucHV0PiovXG4gICkvKjpTaWduYWw8c3RhdGU+Ki8gPT4ge1xuICAgIGNvbnN0IG91dHB1dCA9IG5ldyBJbnB1dChzdGF0ZSlcbiAgICBpbnB1dC5jb25uZWN0KGZvcndhcmQoSW5wdXQuQWRkcmVzcyhvdXRwdXQpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9PiBzdGVwKG91dHB1dC52YWx1ZSwgdmFsdWUpKSlcbiAgcmV0dXJuIG91dHB1dFxufVxuXG5leHBvcnQgY29uc3QgbWFwID0gLyo6OjxhLCBiPiovXG4gICggZi8qOlRyYW5zbGF0ZTxhLCBiPiovXG4gICwgaW5wdXQvKjpTaWduYWw8YT4qL1xuICApLyo6U2lnbmFsPGI+Ki8gPT4ge1xuICAgIGNvbnN0IG91dHB1dCA9IG5ldyBJbnB1dChmKGlucHV0LnZhbHVlKSlcbiAgICBpbnB1dC5jb25uZWN0KGZvcndhcmQoSW5wdXQuQWRkcmVzcyhvdXRwdXQpLCBmKSlcbiAgICByZXR1cm4gb3V0cHV0XG4gIH1cbiJdfQ==