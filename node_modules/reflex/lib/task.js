'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Task = undefined;

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

var _preemptiveAnimationFrame = require('./preemptive-animation-frame');

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var Task = exports.Task = function () {
  _createClass(Task, null, [{
    key: 'create',
    value: function create(execute) {
      console.warn('Task.create is deprecated API use new Task instead');
      return new Task(execute);
    }
  }, {
    key: 'future',
    value: function future(request) {
      console.warn('Task.future is deprecated API use new Task instead');
      return new Future(request);
    }
  }, {
    key: 'succeed',
    value: function succeed(value) {
      return new Succeed(value);
    }
  }, {
    key: 'fail',
    value: function fail(error) {
      return new Fail(error);
    }
  }, {
    key: 'spawn',
    value: function spawn(task) {
      return new Spawn(task);
    }
  }, {
    key: 'sleep',
    value: function sleep(time) {
      return new Sleep(time);
    }
  }, {
    key: 'requestAnimationFrame',
    value: function requestAnimationFrame() {
      return new AnimationFrame();
    }
  }, {
    key: 'send',
    value: function send(address, message) {
      return new Send(address, message);
    }
  }, {
    key: 'fork',
    value: function fork(task, onSucceed, onFail) {
      return Process.fork(task, onSucceed, onFail);
    }
  }]);

  function Task(execute, cancel) {
    _classCallCheck(this, Task);

    if (execute != null) {
      this.fork = execute;
    }
    if (cancel != null) {
      this.abort = cancel;
    }
  }

  _createClass(Task, [{
    key: 'chain',
    value: function chain(next) {
      return new Chain(this, next);
    }
  }, {
    key: 'map',
    value: function map(f) {
      return new Map(this, f);
    }
  }, {
    key: 'capture',
    value: function capture(handle) {
      return new Capture(this, handle);
    }
  }, {
    key: 'format',
    value: function format(f) {
      return new Format(this, f);
    }
  }, {
    key: 'recover',
    value: function recover(regain) {
      return new Recover(this, regain);
    }
  }, {
    key: 'fork',
    value: function fork(succeed, fail) {}
  }, {
    key: 'abort',
    value: function abort(handle) {}
  }]);

  return Task;
}();

var Succeed = function (_Task) {
  _inherits(Succeed, _Task);

  function Succeed(value) {
    _classCallCheck(this, Succeed);

    var _this = _possibleConstructorReturn(this, Object.getPrototypeOf(Succeed).call(this));

    _this.value = value;
    return _this;
  }

  _createClass(Succeed, [{
    key: 'fork',
    value: function fork(succeed, fail) {
      succeed(this.value);
    }
  }]);

  return Succeed;
}(Task);

var Fail = function (_Task2) {
  _inherits(Fail, _Task2);

  function Fail(error) {
    _classCallCheck(this, Fail);

    var _this2 = _possibleConstructorReturn(this, Object.getPrototypeOf(Fail).call(this));

    _this2.error = error;
    return _this2;
  }

  _createClass(Fail, [{
    key: 'fork',
    value: function fork(succeed, fail) {
      fail(this.error);
    }
  }]);

  return Fail;
}(Task);

var Sleep = function (_Task3) {
  _inherits(Sleep, _Task3);

  function Sleep(time) {
    _classCallCheck(this, Sleep);

    var _this3 = _possibleConstructorReturn(this, Object.getPrototypeOf(Sleep).call(this));

    _this3.time = time;
    return _this3;
  }

  _createClass(Sleep, [{
    key: 'fork',
    value: function fork(succeed, fail) {
      return setTimeout(succeed, this.time, void 0);
    }
  }, {
    key: 'abort',
    value: function abort(id) {
      clearTimeout(id);
    }
  }]);

  return Sleep;
}(Task);

var AnimationFrame = function (_Task4) {
  _inherits(AnimationFrame, _Task4);

  function AnimationFrame() {
    _classCallCheck(this, AnimationFrame);

    return _possibleConstructorReturn(this, Object.getPrototypeOf(AnimationFrame).call(this));
  }

  _createClass(AnimationFrame, [{
    key: 'fork',
    value: function fork(succeed, fail) {
      return (0, _preemptiveAnimationFrame.requestAnimationFrame)(succeed);
    }
  }, {
    key: 'abort',
    value: function abort(id) {
      (0, _preemptiveAnimationFrame.cancelAnimationFrame)(id);
    }
  }]);

  return AnimationFrame;
}(Task);

var threadID = 0;

var Spawn = function (_Task5) {
  _inherits(Spawn, _Task5);

  function Spawn(task) {
    _classCallCheck(this, Spawn);

    var _this5 = _possibleConstructorReturn(this, Object.getPrototypeOf(Spawn).call(this));

    _this5.task = task;
    return _this5;
  }

  _createClass(Spawn, [{
    key: 'fork',
    value: function fork(succeed, fail) {
      var _this6 = this;

      Promise.resolve(null).then(function (_) {
        return Task.fork(_this6.task, noop, noop);
      });

      succeed(++threadID);
    }
  }]);

  return Spawn;
}(Task);

var Send = function (_Task6) {
  _inherits(Send, _Task6);

  function Send(address, message) {
    _classCallCheck(this, Send);

    var _this7 = _possibleConstructorReturn(this, Object.getPrototypeOf(Send).call(this));

    _this7.message = message;
    _this7.address = address;
    return _this7;
  }

  _createClass(Send, [{
    key: 'fork',
    value: function fork(succeed, fail) {
      succeed(void this.address(this.message));
    }
  }]);

  return Send;
}(Task);

var Future = function (_Task7) {
  _inherits(Future, _Task7);

  function Future(request) {
    _classCallCheck(this, Future);

    var _this8 = _possibleConstructorReturn(this, Object.getPrototypeOf(Future).call(this));

    _this8.request = request;
    return _this8;
  }

  _createClass(Future, [{
    key: 'fork',
    value: function fork(succeed, fail) {
      this.request().then(succeed, fail);
    }
  }]);

  return Future;
}(Task);

var Then = function (_Task8) {
  _inherits(Then, _Task8);

  function Then(task) {
    _classCallCheck(this, Then);

    var _this9 = _possibleConstructorReturn(this, Object.getPrototypeOf(Then).call(this));

    _this9.task = task;
    return _this9;
  }

  _createClass(Then, [{
    key: 'fork',
    value: function fork(succeed, fail) {
      var _this10 = this;

      this.task.fork(function (value) {
        return void _this10.next(value).fork(succeed, fail);
      }, fail);
    }
  }]);

  return Then;
}(Task);

var Chain = function (_Then) {
  _inherits(Chain, _Then);

  function Chain(task, next) {
    _classCallCheck(this, Chain);

    var _this11 = _possibleConstructorReturn(this, Object.getPrototypeOf(Chain).call(this, task));

    _this11.next = next;
    return _this11;
  }

  return Chain;
}(Then);

var Map = function (_Then2) {
  _inherits(Map, _Then2);

  function Map(task, mapper) {
    _classCallCheck(this, Map);

    var _this12 = _possibleConstructorReturn(this, Object.getPrototypeOf(Map).call(this, task));

    _this12.mapper = mapper;
    return _this12;
  }

  _createClass(Map, [{
    key: 'next',
    value: function next(input) {
      return new Succeed(this.mapper(input));
    }
  }]);

  return Map;
}(Then);

var Catch = function (_Task9) {
  _inherits(Catch, _Task9);

  function Catch(task) {
    _classCallCheck(this, Catch);

    var _this13 = _possibleConstructorReturn(this, Object.getPrototypeOf(Catch).call(this));

    _this13.task = task;
    return _this13;
  }

  _createClass(Catch, [{
    key: 'fork',
    value: function fork(succeed, fail) {
      var _this14 = this;

      this.task.fork(succeed, function (error) {
        return void _this14.handle(error).fork(succeed, fail);
      });
    }
  }]);

  return Catch;
}(Task);

var Capture = function (_Catch) {
  _inherits(Capture, _Catch);

  function Capture(task, handle) {
    _classCallCheck(this, Capture);

    var _this15 = _possibleConstructorReturn(this, Object.getPrototypeOf(Capture).call(this, task));

    _this15.handle = handle;
    return _this15;
  }

  return Capture;
}(Catch);

var Recover = function (_Catch2) {
  _inherits(Recover, _Catch2);

  function Recover(task, regain) {
    _classCallCheck(this, Recover);

    var _this16 = _possibleConstructorReturn(this, Object.getPrototypeOf(Recover).call(this, task));

    _this16.regain = regain;
    return _this16;
  }

  _createClass(Recover, [{
    key: 'handle',
    value: function handle(error) {
      return new Succeed(this.regain(error));
    }
  }]);

  return Recover;
}(Catch);

var Format = function (_Catch3) {
  _inherits(Format, _Catch3);

  function Format(task, formatter) {
    _classCallCheck(this, Format);

    var _this17 = _possibleConstructorReturn(this, Object.getPrototypeOf(Format).call(this, task));

    _this17.formatter = formatter;
    return _this17;
  }

  _createClass(Format, [{
    key: 'handle',
    value: function handle(error) {
      return new Fail(this.formatter(error));
    }
  }]);

  return Format;
}(Catch);

var noop = function noop() {
  return void 0;
};

var nextID = 0;

var Process = function () {
  _createClass(Process, null, [{
    key: 'fork',
    value: function fork(task, onSucceed, onFail) {
      var process = new Process(task);
      process.succeed = onSucceed;
      process.fail = onFail;
      process.schedule();
      return process;
    }
  }]);

  function Process(task) {
    _classCallCheck(this, Process);

    this.id = ++nextID;
    this.position = 0;
    this.root = task;
    this.stack = [];
    this.mailbox = [];
    this.abortHandle = null;
    this.isActive = true;
    this.isPending = false;
    this.success = null;
    this.failure = null;
    this.succeed = null;
    this.fail = null;
    this.onSucceed = this.onSucceed.bind(this);
    this.onFail = this.onFail.bind(this);
  }

  _createClass(Process, [{
    key: 'onSucceed',
    value: function onSucceed(value) {
      if (this.isPending) {
        this.isPending = false;
        this.abortHandle = null;

        if (this.success != null) {
          this.success.value = value;
        } else {
          this.success = new Succeed(value);
        }

        this.root = this.success;
        this.schedule();
      }
    }
  }, {
    key: 'onFail',
    value: function onFail(error) {
      if (this.isPending) {
        this.isPending = false;
        this.abortHandle = null;

        if (this.failure != null) {
          this.failure.error = error;
        } else {
          this.failure = new Fail(error);
        }

        this.root = this.failure;
        this.schedule();
      }
    }
  }, {
    key: 'kill',
    value: function kill(reason) {
      if (this.isActive) {
        this.isActive = false;
        if (this.root.abort) {
          this.root.abort(this.abortHandle);
        }
      }
    }
  }, {
    key: 'schedule',
    value: function schedule() {
      this.step();
    }
  }, {
    key: 'step',
    value: function step() {
      var process = this;
      while (process.isActive) {
        var task = process.root;
        if (task instanceof Succeed) {
          while (process.position < process.stack.length && process.stack[process.position] instanceof Catch) {
            process.position++;
          }

          if (process.position >= process.stack.length) {
            if (process.succeed != null) {
              process.succeed(task.value);
            }
            break;
          }

          var then = process.stack[process.position++];

          process.root = then.next(task.value);
          continue;
        }

        if (task instanceof Fail) {
          while (process.position < process.stack.length && process.stack[process.position] instanceof Then) {
            process.position++;
          }

          if (this.position >= process.stack.length) {
            if (process.fail != null) {
              process.fail(task.error);
            }
            break;
          }

          var _catch = process.stack[process.position++];

          process.root = _catch.handle(task.error);
          continue;
        }

        if (task instanceof Then) {
          if (process.position === 0) {
            process.stack.unshift(task);
          } else {
            process.stack[--process.position] = task;
          }

          process.root = task.task;

          continue;
        }

        if (task instanceof Catch) {
          if (process.position === 0) {
            process.stack.unshift(task);
          } else {
            process.stack[--process.position] = task;
          }

          process.root = task.task;

          continue;
        }

        if (task instanceof Task) {
          process.isPending = true;
          process.abortHandle = task.fork(process.onSucceed, process.onFail);
          break;
        }
      }
    }
  }]);

  return Process;
}();
//# sourceMappingURL=data:application/json;base64,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QUFRLEtBQVIsQ0FBYyxFQUFFLFFBQVEsUUFBUixDQUFoQixHQUFvQyxJQUFwQyxDQURHO1dBSEw7O0FBT0Esa0JBQVEsSUFBUixHQUFlLEtBQUssSUFBTCxDQVJTOztBQVV4QixtQkFWd0I7U0FBMUI7O0FBYUEsWUFBSSxnQkFBZ0IsS0FBaEIsRUFBdUI7QUFDekIsY0FBSSxRQUFRLFFBQVIsS0FBcUIsQ0FBckIsRUFBd0I7QUFDMUIsb0JBQVEsS0FBUixDQUFjLE9BQWQsQ0FBc0IsSUFBdEIsRUFEMEI7V0FBNUIsTUFHSztBQUNILG9CQUFRLEtBQVIsQ0FBYyxFQUFFLFFBQVEsUUFBUixDQUFoQixHQUFvQyxJQUFwQyxDQURHO1dBSEw7O0FBT0Esa0JBQVEsSUFBUixHQUFlLEtBQUssSUFBTCxDQVJVOztBQVV6QixtQkFWeUI7U0FBM0I7O0FBYUEsWUFBSSxnQkFBZ0IsSUFBaEIsRUFBc0I7QUFDeEIsa0JBQVEsU0FBUixHQUFvQixJQUFwQixDQUR3QjtBQUV4QixrQkFBUSxXQUFSLEdBQXNCLEtBQUssSUFBTCxDQUNwQixRQUFRLFNBQVIsRUFDQSxRQUFRLE1BQVIsQ0FGRixDQUZ3QjtBQU14QixnQkFOd0I7U0FBMUI7T0E5RUY7Ozs7U0FyRkUiLCJmaWxlIjoidGFzay5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qIEBmbG93ICovXG5cbmltcG9ydCB7cmVxdWVzdEFuaW1hdGlvbkZyYW1lLCBjYW5jZWxBbmltYXRpb25GcmFtZX0gZnJvbSBcIi4vcHJlZW1wdGl2ZS1hbmltYXRpb24tZnJhbWVcIlxuXG4vKjo6XG5pbXBvcnQgdHlwZSB7QWRkcmVzc30gZnJvbSBcIi4vc2lnbmFsXCJcbmltcG9ydCB0eXBlIHtQcm9jZXNzSUQsIFRocmVhZElELCBUaW1lfSBmcm9tIFwiLi90YXNrXCJcbiovXG5cbmV4cG9ydCBjbGFzcyBUYXNrIC8qOjo8eCwgYT4qLyB7XG4gIC8qOjpcbiAgZm9yazogKHN1Y2NlZWQ6KGE6YSkgPT4gdm9pZCwgZmFpbDooeDp4KSA9PiB2b2lkKSA9PiBhbnk7XG4gIGFib3J0OiAoaGFuZGxlOiopID0+IHZvaWQ7XG4gICovXG4gIHN0YXRpYyBjcmVhdGUgLyo6Ojx4LCBhPiovKGV4ZWN1dGUvKjooc3VjY2VlZDooYTphKSA9PiB2b2lkLCBmYWlsOih4OngpID0+IHZvaWQpID0+IHZvaWQqLykvKjpUYXNrPHgsIGE+Ki8ge1xuICAgIGNvbnNvbGUud2FybignVGFzay5jcmVhdGUgaXMgZGVwcmVjYXRlZCBBUEkgdXNlIG5ldyBUYXNrIGluc3RlYWQnKVxuICAgIHJldHVybiBuZXcgVGFzayhleGVjdXRlKVxuICB9XG4gIHN0YXRpYyBmdXR1cmUgLyo6Ojx4LCBhPiovKHJlcXVlc3QvKjooKSA9PiBQcm9taXNlPGE+Ki8pLyo6VGFzazx4LCBhPiovIHtcbiAgICBjb25zb2xlLndhcm4oJ1Rhc2suZnV0dXJlIGlzIGRlcHJlY2F0ZWQgQVBJIHVzZSBuZXcgVGFzayBpbnN0ZWFkJylcbiAgICByZXR1cm4gbmV3IEZ1dHVyZShyZXF1ZXN0KVxuICB9XG4gIHN0YXRpYyBzdWNjZWVkIC8qOjo8eCwgYT4qLyh2YWx1ZS8qOmEqLykvKjpUYXNrPHgsIGE+Ki8ge1xuICAgIHJldHVybiBuZXcgU3VjY2VlZCh2YWx1ZSlcbiAgfVxuXG4gIHN0YXRpYyBmYWlsIC8qOjo8eCwgYT4qLyAoZXJyb3IvKjp4Ki8pLyo6VGFzazx4LCBhPiovIHtcbiAgICByZXR1cm4gbmV3IEZhaWwoZXJyb3IpXG4gIH1cblxuICBzdGF0aWMgc3Bhd24gLyo6Ojx4LCB5LCBhPiovICh0YXNrLyo6VGFzazx4LCBhPiovKS8qOlRhc2s8eSwgVGhyZWFkSUQ+Ki8ge1xuICAgIHJldHVybiBuZXcgU3Bhd24odGFzaylcbiAgfVxuXG4gIHN0YXRpYyBzbGVlcCAvKjo6PHg+Ki8gKHRpbWU6VGltZSkvKjpUYXNrPHgsIHZvaWQ+Ki8ge1xuICAgIHJldHVybiBuZXcgU2xlZXAodGltZSlcbiAgfVxuXG4gIHN0YXRpYyByZXF1ZXN0QW5pbWF0aW9uRnJhbWUgLyo6Ojx4PiovICgpLyo6VGFzazx4LCBUaW1lPiovIHtcbiAgICByZXR1cm4gbmV3IEFuaW1hdGlvbkZyYW1lKClcbiAgfVxuXG4gIHN0YXRpYyBzZW5kIC8qOjo8eCwgYT4qLyAoYWRkcmVzcy8qOkFkZHJlc3M8YT4qLywgbWVzc2FnZS8qOmEqLykvKjpUYXNrPHgsIHZvaWQ+Ki8ge1xuICAgIHJldHVybiBuZXcgU2VuZChhZGRyZXNzLCBtZXNzYWdlKVxuICB9XG5cbiAgc3RhdGljIGZvcmsgLyo6Ojx4LCBhLCBtZXNzYWdlLCByZWFzb24+Ki8odGFzay8qOlRhc2s8eCwgYT4qLywgb25TdWNjZWVkLyo6KGE6YSkgPT4gdm9pZCovLCBvbkZhaWwvKjooeDp4KSA9PiB2b2lkKi8pLyo6UHJvY2Vzczx4LCBhLCBtZXNzYWdlLCByZWFzb24+Ki8ge1xuICAgIHJldHVybiBQcm9jZXNzLmZvcmsodGFzaywgb25TdWNjZWVkLCBvbkZhaWwpXG4gIH1cblxuICBjb25zdHJ1Y3RvciAvKjo6PGhhbmRsZT4qLyAoXG4gICAgZXhlY3V0ZS8qOj8oc3VjY2VlZDooYTphKSA9PiB2b2lkLCBmYWlsOih4OngpID0+IHZvaWQpID0+IGhhbmRsZSovXG4gICwgY2FuY2VsLyo6PyhoYW5kbGU6aGFuZGxlKSA9PiB2b2lkKi9cbiAgKSB7XG4gICAgaWYgKGV4ZWN1dGUgIT0gbnVsbCkge1xuICAgICAgdGhpcy5mb3JrID0gZXhlY3V0ZVxuICAgIH1cbiAgICBpZiAoY2FuY2VsICE9IG51bGwpIHtcbiAgICAgIHRoaXMuYWJvcnQgPSBjYW5jZWxcbiAgICB9XG4gIH1cbiAgY2hhaW4gLyo6OjxiPiovKG5leHQvKjooYTphKSA9PiBUYXNrPHgsYj4qLykvKjpUYXNrPHgsIGI+Ki8ge1xuICAgIHJldHVybiBuZXcgQ2hhaW4odGhpcywgbmV4dClcbiAgfVxuICBtYXAgLyo6OjxiPiovKGYvKjooaW5wdXQ6YSkgPT4gYiovKS8qOlRhc2s8eCwgYj4qLyB7XG4gICAgcmV0dXJuIG5ldyBNYXAodGhpcywgZilcbiAgfVxuICBjYXB0dXJlIC8qOjo8eT4qLyhoYW5kbGUvKjooZXJyb3I6eCkgPT4gVGFzazx5LCBhPiovKS8qOlRhc2s8eSwgYT4qLyB7XG4gICAgcmV0dXJuIG5ldyBDYXB0dXJlKHRoaXMsIGhhbmRsZSlcbiAgfVxuICBmb3JtYXQgLyo6Ojx5PiovIChmLyo6KGlucHV0OngpID0+IHkqLykvKjpUYXNrPHksIGE+Ki8ge1xuICAgIHJldHVybiBuZXcgRm9ybWF0KHRoaXMsIGYpXG4gIH1cbiAgcmVjb3ZlciAocmVnYWluLyo6KGVycm9yOngpID0+IGEqLykvKjpUYXNrPHgsIGE+Ki8ge1xuICAgIHJldHVybiBuZXcgUmVjb3Zlcih0aGlzLCByZWdhaW4pXG4gIH1cbiAgZm9yayhzdWNjZWVkLyo6KGE6YSkgPT4gdm9pZCovLCBmYWlsLyo6KHg6eCkgPT4gdm9pZCovKS8qOmFueSovIHtcbiAgfVxuICBhYm9ydCAvKjo6PGhhbmRsZT4qLyhoYW5kbGUvKjpoYW5kbGUqLykvKjp2b2lkKi8ge1xuICB9XG59XG5cbmNsYXNzIFN1Y2NlZWQgLyo6Ojx4LGE+Ki8gZXh0ZW5kcyBUYXNrIC8qOjo8eCwgYT4qLyB7XG4gIC8qOjpcbiAgdmFsdWU6IGE7XG4gICovXG4gIGNvbnN0cnVjdG9yKHZhbHVlLyo6YSovKSB7XG4gICAgc3VwZXIoKVxuICAgIHRoaXMudmFsdWUgPSB2YWx1ZVxuICB9XG4gIGZvcmsoc3VjY2VlZC8qOihhOmEpID0+IHZvaWQqLywgZmFpbC8qOih4OngpID0+IHZvaWQqLykvKjp2b2lkKi8ge1xuICAgIHN1Y2NlZWQodGhpcy52YWx1ZSlcbiAgfVxufVxuXG5jbGFzcyBGYWlsIC8qOjo8eCwgYT4qLyBleHRlbmRzIFRhc2sgLyo6Ojx4LCBhPiovIHtcbiAgLyo6OlxuICBlcnJvcjogeDtcbiAgKi9cbiAgY29uc3RydWN0b3IoZXJyb3IvKjp4Ki8pIHtcbiAgICBzdXBlcigpXG4gICAgdGhpcy5lcnJvciA9IGVycm9yXG4gIH1cbiAgZm9yayhzdWNjZWVkLyo6KGE6YSkgPT4gdm9pZCovLCBmYWlsLyo6KHg6eCkgPT4gdm9pZCovKS8qOnZvaWQqLyB7XG4gICAgZmFpbCh0aGlzLmVycm9yKVxuICB9XG59XG5cblxuY2xhc3MgU2xlZXAgLyo6Ojx4LCBhOnZvaWQ+Ki8gZXh0ZW5kcyBUYXNrIC8qOjo8eCwgdm9pZD4qLyB7XG4gIC8qOjpcbiAgdGltZTogVGltZTtcbiAgKi9cbiAgY29uc3RydWN0b3IodGltZS8qOlRpbWUqLykge1xuICAgIHN1cGVyKClcbiAgICB0aGlzLnRpbWUgPSB0aW1lXG4gIH1cbiAgZm9yayhzdWNjZWVkLyo6KGE6YSkgPT4gdm9pZCovLCBmYWlsLyo6KHg6eCkgPT4gdm9pZCovKS8qOm51bWJlciovIHtcbiAgICByZXR1cm4gc2V0VGltZW91dChzdWNjZWVkLCB0aGlzLnRpbWUsIHZvaWQoMCkpXG4gIH1cbiAgYWJvcnQoaWQvKjpudW1iZXIqLykvKjp2b2lkKi8ge1xuICAgIGNsZWFyVGltZW91dChpZClcbiAgfVxufVxuXG5jbGFzcyBBbmltYXRpb25GcmFtZSAvKjo6PHg+Ki8gZXh0ZW5kcyBUYXNrIC8qOjo8eCwgVGltZT4qLyB7XG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHN1cGVyKClcbiAgfVxuICBmb3JrKHN1Y2NlZWQvKjooYTpUaW1lKSA9PiB2b2lkKi8sIGZhaWwvKjooeDp4KSA9PiB2b2lkKi8pLyo6bnVtYmVyKi8ge1xuICAgIHJldHVybiByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoc3VjY2VlZClcbiAgfVxuICBhYm9ydChpZC8qOm51bWJlciovKS8qOnZvaWQqLyB7XG4gICAgY2FuY2VsQW5pbWF0aW9uRnJhbWUoaWQpXG4gIH1cbn1cblxubGV0IHRocmVhZElEID0gMFxuY2xhc3MgU3Bhd24gLyo6Ojx4LCB5LCBhPiovIGV4dGVuZHMgVGFzayAvKjo6PHksIFRocmVhZElEPiovIHtcbiAgLyo6OlxuICB0YXNrOiBUYXNrPHgsIGE+O1xuICAqL1xuICBjb25zdHJ1Y3Rvcih0YXNrLyo6VGFzazx4LCBhPiovKSB7XG4gICAgc3VwZXIoKVxuICAgIHRoaXMudGFzayA9IHRhc2tcbiAgfVxuICBmb3JrKHN1Y2NlZWQvKjooYTpUaHJlYWRJRCkgPT4gdm9pZCovLCBmYWlsLyo6KHg6eSkgPT4gdm9pZCovKS8qOnZvaWQqLyB7XG4gICAgUHJvbWlzZVxuICAgIC5yZXNvbHZlKG51bGwpXG4gICAgLnRoZW4oXyA9PiBUYXNrLmZvcmsodGhpcy50YXNrLCBub29wLCBub29wKSlcblxuICAgIHN1Y2NlZWQoKyt0aHJlYWRJRClcbiAgfVxufVxuXG5jbGFzcyBTZW5kIC8qOjo8eCwgYT4qLyBleHRlbmRzIFRhc2sgLyo6Ojx4LCB2b2lkPiovIHtcbiAgLyo6OlxuICBtZXNzYWdlOiBhO1xuICBhZGRyZXNzOiBBZGRyZXNzPGE+O1xuICAqL1xuICBjb25zdHJ1Y3RvcihhZGRyZXNzLyo6QWRkcmVzczxhPiovLCBtZXNzYWdlLyo6YSovKSB7XG4gICAgc3VwZXIoKVxuICAgIHRoaXMubWVzc2FnZSA9IG1lc3NhZ2VcbiAgICB0aGlzLmFkZHJlc3MgPSBhZGRyZXNzXG4gIH1cbiAgZm9yayhzdWNjZWVkLyo6KGE6dm9pZCkgPT4gdm9pZCovLCBmYWlsLyo6KHg6eCkgPT4gdm9pZCovKS8qOnZvaWQqLyB7XG4gICAgc3VjY2VlZCh2b2lkKHRoaXMuYWRkcmVzcyh0aGlzLm1lc3NhZ2UpKSlcbiAgfVxufVxuXG5jbGFzcyBGdXR1cmUgLyo6Ojx4LCBhPiovIGV4dGVuZHMgVGFzay8qOjo8eCwgYT4qLyB7XG4gIC8qOjpcbiAgcmVxdWVzdDogKCkgPT4gUHJvbWlzZTxhPjtcbiAgKi9cbiAgY29uc3RydWN0b3IocmVxdWVzdC8qOigpID0+IFByb21pc2U8YT4qLykge1xuICAgIHN1cGVyKClcbiAgICB0aGlzLnJlcXVlc3QgPSByZXF1ZXN0XG4gIH1cbiAgZm9yayhzdWNjZWVkLyo6KGE6YSkgPT4gdm9pZCovLCBmYWlsLyo6KHg6eCkgPT4gdm9pZCovKS8qOnZvaWQqLyB7XG4gICAgdGhpcy5yZXF1ZXN0KCkudGhlbihzdWNjZWVkLCBmYWlsKVxuICB9XG59XG5cbmNsYXNzIFRoZW4gLyo6Ojx4LCBhLCBiPiovIGV4dGVuZHMgVGFzay8qOjo8eCwgYj4qLyB7XG4gIC8qOjpcbiAgdGFzazogVGFzazx4LCBhPjtcbiAgbmV4dDogKGlucHV0OmEpID0+IFRhc2s8eCwgYj47XG4gICovXG4gIGNvbnN0cnVjdG9yKHRhc2svKjpUYXNrPHgsIGE+Ki8pIHtcbiAgICBzdXBlcigpXG4gICAgdGhpcy50YXNrID0gdGFza1xuICB9XG4gIGZvcmsoc3VjY2VlZC8qOih2YWx1ZTpiKSA9PiB2b2lkKi8sIGZhaWwvKjooZXJyb3I6eCkgPT4gdm9pZCovKS8qOnZvaWQqLyB7XG4gICAgdGhpcy50YXNrLmZvcmtcbiAgICAoIHZhbHVlID0+IHZvaWQodGhpcy5uZXh0KHZhbHVlKS5mb3JrKHN1Y2NlZWQsIGZhaWwpKVxuICAgICwgZmFpbFxuICAgIClcbiAgfVxufVxuXG5jbGFzcyBDaGFpbiAvKjo6PHgsIGEsIGI+Ki8gZXh0ZW5kcyBUaGVuLyo6Ojx4LCBhLCBiPiovIHtcbiAgY29uc3RydWN0b3IodGFzay8qOlRhc2s8eCwgYT4qLywgbmV4dC8qOihpbnB1dDphKSA9PiBUYXNrPHgsIGI+Ki8pIHtcbiAgICBzdXBlcih0YXNrKVxuICAgIHRoaXMubmV4dCA9IG5leHRcbiAgfVxufVxuXG5jbGFzcyBNYXAgLyo6Ojx4LCBhLCBiPiovIGV4dGVuZHMgVGhlbi8qOjo8eCwgYSwgYj4qLyB7XG4gIC8qOjpcbiAgbWFwcGVyOiAoaW5wdXQ6YSkgPT4gYjtcbiAgKi9cbiAgY29uc3RydWN0b3IodGFzay8qOlRhc2s8eCwgYT4qLywgbWFwcGVyLyo6KGlucHV0OmEpID0+IGIqLykge1xuICAgIC8vIE5vdGU6IEhhZCB0byB0cmljayBmbG93IGludG8gdGhpbmtpbmcgdGhhdCBgRm9ybWF0LnByb3RvdHlwZS5oYW5kbGVgIHdhc1xuICAgIC8vIHBhc3NlZCwgb3RoZXJ3aXNlIGl0IGZhaWxzIHRvIGluZmVyIHBvbHltb3JwaGljIG5hdHVyZS5cbiAgICBzdXBlcih0YXNrKVxuICAgIHRoaXMubWFwcGVyID0gbWFwcGVyXG4gIH1cbiAgbmV4dChpbnB1dC8qOmEqLykvKjpUYXNrPHgsIGI+Ki8ge1xuICAgIHJldHVybiBuZXcgU3VjY2VlZCh0aGlzLm1hcHBlcihpbnB1dCkpXG4gIH1cbn1cblxuY2xhc3MgQ2F0Y2ggLyo6Ojx4LCB5LCBhPiovIGV4dGVuZHMgVGFzay8qOjo8eSwgYT4qLyB7XG4gIC8qOjpcbiAgdGFzazogVGFzazx4LCBhPjtcbiAgaGFuZGxlOiAoZXJyb3I6eCkgPT4gVGFzazx5LCBhPjtcbiAgKi9cbiAgY29uc3RydWN0b3IodGFzay8qOlRhc2s8eCwgYT4qLykge1xuICAgIHN1cGVyKClcbiAgICB0aGlzLnRhc2sgPSB0YXNrXG4gIH1cbiAgZm9yayhzdWNjZWVkLyo6KHZhbHVlOmEpID0+IHZvaWQqLywgZmFpbC8qOihlcnJvcjp5KSA9PiB2b2lkKi8pLyo6dm9pZCovIHtcbiAgICB0aGlzLnRhc2suZm9ya1xuICAgICggc3VjY2VlZFxuICAgICwgZXJyb3IgPT4gdm9pZCh0aGlzLmhhbmRsZShlcnJvcikuZm9yayhzdWNjZWVkLCBmYWlsKSlcbiAgICApXG4gIH1cbn1cblxuY2xhc3MgQ2FwdHVyZS8qOjo8eCwgeSwgYT4qL2V4dGVuZHMgQ2F0Y2gvKjo6PHgsIHksIGE+Ki97XG4gIC8qOjpcbiAgaGFuZGxlOiAoZXJyb3I6eCkgPT4gVGFzazx5LCBhPjtcbiAgKi9cbiAgY29uc3RydWN0b3IodGFzay8qOlRhc2s8eCwgYT4qLywgaGFuZGxlLyo6KGVycm9yOngpID0+IFRhc2s8eSwgYT4qLykge1xuICAgIHN1cGVyKHRhc2spXG4gICAgdGhpcy5oYW5kbGUgPSBoYW5kbGVcbiAgfVxufVxuXG5jbGFzcyBSZWNvdmVyLyo6Ojx4LCBhPiovZXh0ZW5kcyBDYXRjaC8qOjo8eCwgeCwgYT4qLyB7XG4gIC8qOjpcbiAgcmVnYWluOiAoZXJyb3I6eCkgPT4gYTtcbiAgKi9cbiAgY29uc3RydWN0b3IodGFzay8qOlRhc2s8eCwgYT4qLywgcmVnYWluLyo6KGVycm9yOngpID0+IGEqLykge1xuICAgIHN1cGVyKHRhc2spXG4gICAgdGhpcy5yZWdhaW4gPSByZWdhaW5cbiAgfVxuICBoYW5kbGUoZXJyb3IvKjp4Ki8pLyo6VGFzazx4LCBhPiovIHtcbiAgICByZXR1cm4gbmV3IFN1Y2NlZWQodGhpcy5yZWdhaW4oZXJyb3IpKVxuICB9XG59XG5cbmNsYXNzIEZvcm1hdC8qOjo8eCwgeSwgYT4qL2V4dGVuZHMgQ2F0Y2gvKjo6PHgsIHksIGE+Ki97XG4gIC8qOjpcbiAgZm9ybWF0dGVyOiAoZXJyb3I6eCkgPT4geTtcbiAgKi9cbiAgY29uc3RydWN0b3IodGFzay8qOlRhc2s8eCwgYT4qLywgZm9ybWF0dGVyLyo6KGVycm9yOngpID0+IHkqLykge1xuICAgIHN1cGVyKHRhc2spXG4gICAgdGhpcy5mb3JtYXR0ZXIgPSBmb3JtYXR0ZXJcbiAgfVxuICBoYW5kbGUoZXJyb3IvKjp4Ki8pLyo6VGFzazx5LCBhPiovIHtcbiAgICByZXR1cm4gbmV3IEZhaWwodGhpcy5mb3JtYXR0ZXIoZXJyb3IpKVxuICB9XG59XG5cblxuY29uc3Qgbm9vcCA9ICgpID0+IHZvaWQoMClcblxubGV0IG5leHRJRCA9IDBcblxuY2xhc3MgUHJvY2VzcyAvKjo6PGVycm9yLCB2YWx1ZSwgbWVzc2FnZSwgcmVhc29uPiovIHtcbiAgLyo6OlxuICBpZDogUHJvY2Vzc0lEO1xuICByb290OiBUYXNrPCosICo+O1xuICBzdGFjazogQXJyYXk8Q2F0Y2g8KiwgKiwgKj4gfCBUaGVuPCosICosICo+PjtcbiAgcG9zaXRpb246IG51bWJlcjtcbiAgbWFpbGJveDogQXJyYXk8bWVzc2FnZT47XG4gIGFib3J0SGFuZGxlOiAqO1xuICBpc0FjdGl2ZTogYm9vbGVhbjtcbiAgc3VjY2VlZDogPyhpbnB1dDp2YWx1ZSkgPT4gdm9pZDtcbiAgZmFpbDogPyhlcnJvcjplcnJvcikgPT4gdm9pZDtcbiAgaXNQZW5kaW5nOiBib29sZWFuO1xuICBzdWNjZXNzOiA/U3VjY2VlZDwqLCAqPjtcbiAgZmFpbHVyZTogP0ZhaWw8KiwgKj47XG4gIG9uU3VjY2VlZDogPHZhbHVlPiAoaW5wdXQ6dmFsdWUpID0+IHZvaWQ7XG4gIG9uRmFpbDogPGVycm9yPiAoZXJyb3I6ZXJyb3IpID0+IHZvaWQ7XG4gICovXG4gIHN0YXRpYyBmb3JrIC8qOjo8ZXJyb3IsIHZhbHVlLCBtZXNzYWdlLCByZWFzb24+Ki8odGFzay8qOlRhc2s8ZXJyb3IsIHZhbHVlPiovLCBvblN1Y2NlZWQvKjooaW5wdXQ6dmFsdWUpID0+IHZvaWQqLywgb25GYWlsLyo6KGVycm9yOmVycm9yKSA9PiB2b2lkKi8pLyo6UHJvY2VzczxlcnJvciwgdmFsdWUsIG1lc3NhZ2UsIHJlYXNvbj4qLyB7XG4gICAgY29uc3QgcHJvY2VzcyA9IG5ldyBQcm9jZXNzKHRhc2spXG4gICAgcHJvY2Vzcy5zdWNjZWVkID0gb25TdWNjZWVkXG4gICAgcHJvY2Vzcy5mYWlsID0gb25GYWlsXG4gICAgcHJvY2Vzcy5zY2hlZHVsZSgpXG4gICAgcmV0dXJuIHByb2Nlc3NcbiAgfVxuICBjb25zdHJ1Y3Rvcih0YXNrLyo6VGFzazxhbnksIGFueT4qLykge1xuICAgIHRoaXMuaWQgPSArK25leHRJRFxuICAgIHRoaXMucG9zaXRpb24gPSAwXG4gICAgdGhpcy5yb290ID0gdGFza1xuICAgIHRoaXMuc3RhY2sgPSBbXVxuICAgIHRoaXMubWFpbGJveCA9IFtdXG4gICAgdGhpcy5hYm9ydEhhbmRsZSA9IG51bGxcbiAgICB0aGlzLmlzQWN0aXZlID0gdHJ1ZVxuICAgIHRoaXMuaXNQZW5kaW5nID0gZmFsc2VcbiAgICB0aGlzLnN1Y2Nlc3MgPSBudWxsXG4gICAgdGhpcy5mYWlsdXJlID0gbnVsbFxuICAgIHRoaXMuc3VjY2VlZCA9IG51bGxcbiAgICB0aGlzLmZhaWwgPSBudWxsXG4gICAgdGhpcy5vblN1Y2NlZWQgPSB0aGlzLm9uU3VjY2VlZC5iaW5kKHRoaXMpXG4gICAgdGhpcy5vbkZhaWwgPSB0aGlzLm9uRmFpbC5iaW5kKHRoaXMpXG4gIH1cbiAgb25TdWNjZWVkKHZhbHVlKSB7XG4gICAgaWYgKHRoaXMuaXNQZW5kaW5nKSB7XG4gICAgICB0aGlzLmlzUGVuZGluZyA9IGZhbHNlXG4gICAgICB0aGlzLmFib3J0SGFuZGxlID0gbnVsbFxuXG4gICAgICBpZiAodGhpcy5zdWNjZXNzICE9IG51bGwpIHtcbiAgICAgICAgdGhpcy5zdWNjZXNzLnZhbHVlID0gdmFsdWVcbiAgICAgIH1cbiAgICAgIGVsc2Uge1xuICAgICAgICB0aGlzLnN1Y2Nlc3MgPSBuZXcgU3VjY2VlZCh2YWx1ZSlcbiAgICAgIH1cblxuICAgICAgdGhpcy5yb290ID0gdGhpcy5zdWNjZXNzXG4gICAgICB0aGlzLnNjaGVkdWxlKClcbiAgICB9XG4gIH1cbiAgb25GYWlsKGVycm9yKSB7XG4gICAgaWYgKHRoaXMuaXNQZW5kaW5nKSB7XG4gICAgICB0aGlzLmlzUGVuZGluZyA9IGZhbHNlXG4gICAgICB0aGlzLmFib3J0SGFuZGxlID0gbnVsbFxuXG4gICAgICBpZiAodGhpcy5mYWlsdXJlICE9IG51bGwpIHtcbiAgICAgICAgdGhpcy5mYWlsdXJlLmVycm9yID0gZXJyb3JcbiAgICAgIH1cbiAgICAgIGVsc2Uge1xuICAgICAgICB0aGlzLmZhaWx1cmUgPSBuZXcgRmFpbChlcnJvcilcbiAgICAgIH1cblxuICAgICAgdGhpcy5yb290ID0gdGhpcy5mYWlsdXJlXG4gICAgICB0aGlzLnNjaGVkdWxlKClcbiAgICB9XG4gIH1cbiAga2lsbChyZWFzb24vKjpyZWFzb24qLykge1xuICAgIGlmICh0aGlzLmlzQWN0aXZlKSB7XG4gICAgICB0aGlzLmlzQWN0aXZlID0gZmFsc2VcbiAgICAgIGlmICh0aGlzLnJvb3QuYWJvcnQpIHtcbiAgICAgICAgdGhpcy5yb290LmFib3J0KHRoaXMuYWJvcnRIYW5kbGUpXG4gICAgICB9XG4gICAgfVxuICB9XG4gIHNjaGVkdWxlKCkge1xuICAgIHRoaXMuc3RlcCgpXG4gIH1cbiAgc3RlcCgpIHtcbiAgICBjb25zdCBwcm9jZXNzID0gdGhpc1xuICAgIHdoaWxlIChwcm9jZXNzLmlzQWN0aXZlKSB7XG4gICAgICBjb25zdCB0YXNrID0gcHJvY2Vzcy5yb290XG4gICAgICBpZiAodGFzayBpbnN0YW5jZW9mIFN1Y2NlZWQpIHtcbiAgICAgICAgLy8gSWYgdGFzayBzdWNjZWVkZWQgc2tpcCBhbGwgdGhlIGVycm9yIGhhbmRsaW5nLlxuICAgICAgICB3aGlsZVxuICAgICAgICAoIHByb2Nlc3MucG9zaXRpb24gPCBwcm9jZXNzLnN0YWNrLmxlbmd0aCAmJlxuICAgICAgICAgIHByb2Nlc3Muc3RhY2tbcHJvY2Vzcy5wb3NpdGlvbl0gaW5zdGFuY2VvZiBDYXRjaFxuICAgICAgICApXG4gICAgICAgIHtcbiAgICAgICAgICBwcm9jZXNzLnBvc2l0aW9uICsrXG4gICAgICAgIH1cblxuICAgICAgICAvLyBJZiBlbmQgb2YgdGhlIHN0YWNrIGlzIHJlYWNoZWQgdGhlbiBicmVha1xuICAgICAgICBpZiAocHJvY2Vzcy5wb3NpdGlvbiA+PSBwcm9jZXNzLnN0YWNrLmxlbmd0aCkge1xuICAgICAgICAgIGlmIChwcm9jZXNzLnN1Y2NlZWQgIT0gbnVsbCkge1xuICAgICAgICAgICAgcHJvY2Vzcy5zdWNjZWVkKHRhc2sudmFsdWUpXG4gICAgICAgICAgfVxuICAgICAgICAgIGJyZWFrXG4gICAgICAgIH1cblxuICAgICAgICAvLyBPdGhlcndpc2Ugc3RlcCBpbnRvIG5leHQgdGFzay5cbiAgICAgICAgY29uc3QgdGhlbiA9IHByb2Nlc3Muc3RhY2tbcHJvY2Vzcy5wb3NpdGlvbisrXVxuICAgICAgICAvKjo6IGlmICh0aGVuIGluc3RhbmNlb2YgVGhlbikgKi9cbiAgICAgICAgcHJvY2Vzcy5yb290ID0gdGhlbi5uZXh0KHRhc2sudmFsdWUpXG4gICAgICAgIGNvbnRpbnVlXG4gICAgICB9XG5cbiAgICAgIGlmICh0YXNrIGluc3RhbmNlb2YgRmFpbCkge1xuICAgICAgICAvLyBJZiB0YXNrIGZhaWxzIHNraXAgYWxsIHRoZSBjaGFpbmluZy5cbiAgICAgICAgd2hpbGVcbiAgICAgICAgKCBwcm9jZXNzLnBvc2l0aW9uIDwgcHJvY2Vzcy5zdGFjay5sZW5ndGggJiZcbiAgICAgICAgICBwcm9jZXNzLnN0YWNrW3Byb2Nlc3MucG9zaXRpb25dIGluc3RhbmNlb2YgVGhlblxuICAgICAgICApXG4gICAgICAgIHtcbiAgICAgICAgICBwcm9jZXNzLnBvc2l0aW9uICsrXG4gICAgICAgIH1cblxuICAgICAgICAvLyBJZiBlbmQgb2YgdGhlIHN0YWNrIGlzIHJlYWNoZWQgdGhlbiBicmVhay5cbiAgICAgICAgaWYgKHRoaXMucG9zaXRpb24gPj0gcHJvY2Vzcy5zdGFjay5sZW5ndGgpIHtcbiAgICAgICAgICBpZiAocHJvY2Vzcy5mYWlsICE9IG51bGwpIHtcbiAgICAgICAgICAgIHByb2Nlc3MuZmFpbCh0YXNrLmVycm9yKVxuICAgICAgICAgIH1cbiAgICAgICAgICBicmVha1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gT3RoZXJ3aXNlIHN0ZXAgaW50byBuZXh0IHRhc2suXG4gICAgICAgIGNvbnN0IF9jYXRjaCA9IHByb2Nlc3Muc3RhY2tbcHJvY2Vzcy5wb3NpdGlvbisrXVxuICAgICAgICAvKjo6IGlmIChfY2F0Y2ggaW5zdGFuY2VvZiBDYXRjaCkgKi9cbiAgICAgICAgcHJvY2Vzcy5yb290ID0gX2NhdGNoLmhhbmRsZSh0YXNrLmVycm9yKVxuICAgICAgICBjb250aW51ZVxuICAgICAgfVxuXG4gICAgICBpZiAodGFzayBpbnN0YW5jZW9mIFRoZW4pIHtcbiAgICAgICAgaWYgKHByb2Nlc3MucG9zaXRpb24gPT09IDApIHtcbiAgICAgICAgICBwcm9jZXNzLnN0YWNrLnVuc2hpZnQodGFzaylcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICBwcm9jZXNzLnN0YWNrWy0tcHJvY2Vzcy5wb3NpdGlvbl0gPSB0YXNrXG4gICAgICAgIH1cblxuICAgICAgICBwcm9jZXNzLnJvb3QgPSB0YXNrLnRhc2tcblxuICAgICAgICBjb250aW51ZVxuICAgICAgfVxuXG4gICAgICBpZiAodGFzayBpbnN0YW5jZW9mIENhdGNoKSB7XG4gICAgICAgIGlmIChwcm9jZXNzLnBvc2l0aW9uID09PSAwKSB7XG4gICAgICAgICAgcHJvY2Vzcy5zdGFjay51bnNoaWZ0KHRhc2spXG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgcHJvY2Vzcy5zdGFja1stLXByb2Nlc3MucG9zaXRpb25dID0gdGFza1xuICAgICAgICB9XG5cbiAgICAgICAgcHJvY2Vzcy5yb290ID0gdGFzay50YXNrXG5cbiAgICAgICAgY29udGludWVcbiAgICAgIH1cblxuICAgICAgaWYgKHRhc2sgaW5zdGFuY2VvZiBUYXNrKSB7XG4gICAgICAgIHByb2Nlc3MuaXNQZW5kaW5nID0gdHJ1ZVxuICAgICAgICBwcm9jZXNzLmFib3J0SGFuZGxlID0gdGFzay5mb3JrXG4gICAgICAgICggcHJvY2Vzcy5vblN1Y2NlZWRcbiAgICAgICAgLCBwcm9jZXNzLm9uRmFpbFxuICAgICAgICApXG4gICAgICAgIGJyZWFrXG4gICAgICB9XG4gICAgfVxuICB9XG59XG4iXX0=